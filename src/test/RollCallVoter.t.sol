// SPDX-License-Identifier: Unlicense
pragma solidity ^0.8.9;

import "ds-test/test.sol";
import {ERC20} from "openzeppelin-contracts/token/ERC20/ERC20.sol";
import {OptimismVm, OptimismTest} from "forge-optimism/Optimism.sol";

import {Vm} from "./lib/Vm.sol";
import {OVM_FakeL1BlockNumber} from "./OVM_FakeL1BlockNumber.sol";
import {Lib_PredeployAddresses} from "../lib/Lib_PredeployAddresses.sol";

import {Bridge} from "../Bridge.sol";
import {IL1Governor} from "../interfaces/IL1Governor.sol";
import {IL2Voter} from "../interfaces/IL2Voter.sol";
import {L2Voter} from "../L2Voter.sol";

contract GovernanceERC20 is ERC20 {
    constructor() ERC20("Rollcall", "ROLLCALL") {}

    function mint(address to, uint256 amount) public {
        _mint(to, amount);
    }
}

contract L1Governor {
    bytes32 public queueId;
    uint256[10] public queueVotes;

    Bridge internal bridge;

    mapping(bytes32 => IL1Governor.Proposal) internal proposals;

    constructor(address bridge_) {
        bridge = Bridge(bridge_);
    }

    function propose(bytes32 id, IL1Governor.Proposal memory p)
        external
    {
        proposals[id] = p;
        bridge.propose(id);
    }

    function proposal(bytes32 id)
        public
        view
        virtual
        returns (IL1Governor.Proposal memory)
    {
        return proposals[id];
    }

    function sources() external pure virtual returns (address[] memory) {
        address[] memory s = new address[](1);
        s[0] = 0x7aE1D57b58fA6411F32948314BadD83583eE0e8C;
        return s;
    }

    function slots() external pure virtual returns (bytes32[] memory) {
        bytes32[] memory s = new bytes32[](1);
        s[0] = bytes32(uint256(0));
        return s;
    }

    function queue(bytes32 id, uint256[10] calldata votes) external virtual {
        queueId = id;
        queueVotes = votes;
    }

    function test() public returns (uint) {
        return 0;
    }
}

contract L2VoterTester is L2Voter {
    constructor(address bridge_) public L2Voter(bridge_) {}

    function hashTypedDataV4(bytes32 id, uint256 support)
        public
        view
        virtual
        returns (bytes32)
    {
        return
            _hashTypedDataV4(
                keccak256(abi.encode(BALLOT_TYPEHASH, id, support))
            );
    }
}

contract L2VoterSetup is OptimismTest, DSTest {
    Vm internal vm = Vm(0x7109709ECfa91a80626fF3989D68f67F5b1DD12D);
    OptimismVm internal ovm = new OptimismVm();
    GovernanceERC20 internal token;
    Bridge internal bridge;
    L2VoterTester internal voter;
    L1Governor internal governor;

    function setUp() public virtual override {
        super.setUp();

        bridge = new Bridge(l1cdm);

        voter = new L2VoterTester(address(bridge));

        governor = new L1Governor(address(bridge));

        bridge.setVoter(address(voter));
    }
}

contract L2Voter_Proposing is L2VoterSetup {
    function testCanPropose() public {
        uint64 ts = uint64(block.timestamp);
        governor.propose(
            bytes32(uint256(1)),
            IL1Governor.Proposal({
                snapshot: hex"d077c85d25408ee51a05118a39ccc8ab0ae80db65f60a18ea0209960bcfc9e4e",
                start: ts,
                end: ts + 100,
                executed: false,
                canceled: false
            })
        );
    }

    function testCanActivate() public {
        bytes32 id = bytes32(uint256(1));
        uint64 ts = uint64(block.timestamp);
        governor.propose(
            id,
            IL1Governor.Proposal({
                snapshot: hex"d077c85d25408ee51a05118a39ccc8ab0ae80db65f60a18ea0209960bcfc9e4e",
                start: ts,
                end: ts + 100,
                executed: false,
                canceled: false
            })
        );

        voter.activate(
            address(governor),
            id,
            hex"f90215a06c677c79f07249f5af85156dc66a33c2d1a2e843ab1ce80f953d0079e780587da01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d493479452bc44d5378309ee2abf1539bf71de1b7d7be3b5a04d65424d564e39f92e231c095100877ebe8bac54776632b75be295d983746127a0a96cac5b975d6c89c3ffb148cf76088be45810ae7950993bcf40a899282a628fa042402e593d83815dda04b367c05dc9bee01b61e9746a05182f2e0537853a5185b90100fd7eee26d7d73ef5f9ac35fdeebd9beddfb878fda816feb8ea97b35937fadfbbb35509fee6ff4ededf5d7fcce25f9952feadfd5ffd7bfdbdbe7e98fc3fbbf3eb3cedcf9797bab5eb5bcbfebeeb3abbf38ef2b437f5d9bbd7bff73f79a07391533f1792b5cf7f5bb59dd435fbede2f9f374f98bb802ff3d5457dcdf52fed8595dff7ee7fa46c3b53fea4b8df1fbf6cae77fed14d7db93b7fd7fa3a4dfeef57936f3dbff1d9e9327f6deb747d6edb517716bc4dbedb77b6a7fe1e2beee3df99455f52cfeef8fff5ff5f3550fe65eebcba7ad694febdfab6f132cfadfbebf632674edbf68ffd311faf02ffeb6e1d1af2ceb47ede9fdf3ebbf6db977f9bfd58bf77f872b1e4e28cf0a9083d4a0048401c9c3808401c9afa08461d358fe8c6e616e6f706f6f6c2e6f7267a0959d62b6259bb2b4fc37375c5c41496c8af646b1248827088b61742fcc8fc567883aabff9550735bc7851cbc487a76",
            hex"f90e37f90e34f90211a0ace0683393fa65a836500367726de537eaf01c0144167cbc683677c96ba8df42a0d78f99814dbc434189a56d14df9dc8f4ab0ef747f2da2e1f30cc72eff8dcf86ca0c885caabd49f5acab72455ec405ff166e889aab046c01e3afe10492649c72334a08f8fa912744fe7d1f33088034e7cb75a2e61313fc59e0d33b2dc5ead96fc3e1aa024da5f344ca4809a38cb6098fb1db76ecedfed033775315594dc446c8a409b5aa05f3202c834b6a346cb647a7352e49f01003e44e63536680120e269ce30d04ab7a0fd7df6d8b821ee6623651b7242e59db0fce86bbe36a1627aa59c74ecedb75b85a0d26cc5fad9973b4610b5711847330359e7bce938c8edbb64c0d41a060e0357f5a003757d01388b256af41e384b37a90eac3d396c359125e7f3de7dd959fd417f46a0774916a1f706db63a9f3894682dcc66811aac05aa99bd98cad6445475c1e5606a0bf3c129eb79cc7dfe7349f8f4a7d13cff3def1185e967ecc671c932976986394a0784433c64bd71e32144983e961c45ccadb67c58d990c97af4a773f04198daf12a0e2d3456b9ac2cf404e7e802e6b992d022484eb03f12058973f7702f2dc0c5c75a0538f488cf68a51e6ec8744bb3b63f6be3d7397fe9a97d7b294ac6275ebd0c710a023cdb85019317522b83194468054bdc3f8b4b25561294908c741b0b5c0f6459ea0da62084f1ce9d271f37fb2b4e921cc0d8aa4be3f40d86574286b2b6c83a5373080f90211a050ef96a9d0214264a728fb72aacd0117359359b2593a23a4c3ea11f4e9a94ef6a048fd38c578b2bc35f37b96e7f6a09b29378f2e7259b04d0ee546e9e72b51620aa01cb98cc6018dc16bc002a1ebadb9650e9bb20eae4114bda552beb511e18ca188a00613ad5dc585e8fdb1c585b9e7b061cbdb86a3b888665f9e74cec6d6fddc2fbea0d302ef04ccbb0be012de45ea55c5022f94f3419fadcabb3546dd8c07befb4e35a007adcf416194b65efa11b40683c564a0a8910b14b1ee1dcefd16aa6e88488715a09f1c78a7bb8f1dfed06d646e5a5be4c94b0a05c2584616db445a4e07d928a63ea0e2bc7b885dc0e7d59b38c004dc0b9f8fd2856d6b3caf5565ee0b8f607abeb3e8a0640562342b8842137ec7a836ee845f33ac569c01f2e4369db67eddc68f78b43da0f89330885daf7742939734cff2872cb91a297fd980a956d6de6e2d7d1d14c543a084331284a7ca49e823bd79208b2ea477cf025950f95085a2511f2f0721bf559da0d4d0bf57f17176d1ab6ea91f654c14acc5c2236ddccbc2ff596d8d96612611b2a02917bd1ffe56666efa5918930b131e29cf31113e51112a2569843d89e1ebc667a016a6d4af52dda35added8e58f0a0312c49fdab14caa84695dc003219541a7b16a03d73a06b5355a287887e3b17cfdae97754b7572189d6597a2b5f426cc2efd642a0a689e73b53a22048748d240a04caab3a92b24aa13e50d243968d14ea4761a44480f90211a0be56858fbdebdb81b95067017ddc33ceb9e32df1fd4862ece8940336ae744dc0a0e5243274228eb856c3c4fcab9ff34ffafe236f044f9ed8250262149f37e4e9faa0d7e5fccfc58ab4a86e1ad8aafd7586cbd6c5f52c48b46e8500c106f88cbf6660a054210e8b00ebf19ccfec880c04e475e8a05f5af17c072bda449f89c78cfadaf4a0fc2fd481b6569015dcc136c3afe1e67831d77ffc20a2ba614e6dd49d3e52cb6fa0dc088781c0596a64cf9fd7ceaa6bf906cad1150b248449836a411a5a929da5c5a0e01313b2738360d14a03ae5a20d562a643c644895533e364b00bb010b00898eda095e06e228fd36cc2878ece64defabc384ea9c891be3dd0210260285c7f5c5727a000d7a2b9a8700db743a58f529df4f618732928809b9c30274faac304507de28ba07a60ebccbda505d3763b07acbd8b0c07cf21196bc69dadd2e0101f708c0fa0caa0030a2cd41a46333dc9f6a80db1b1c411bbbc8c67cb0553c733b01ff7947f4722a0795176c823536428f7483857aed4960e7ffb2aa542adb62f214382eab4202de1a07523340d574fb04a8e79510a0b8af8aebfcbd948e69e3426dab0994f5b33fa47a05b14bb5df540a2db54501dc0976899879fb379fcd930c3082e7008393871d016a05e40cb28bf4679e4452272b5507b8987223a1472e7d292d94b9f39edb940c31da04457ad4c9d7395dcd8a34167bcc0186546554f856faa47ef3a8f42030cb93d8180f90211a0293fc33d0a7ae73581abde554f48182a64e29e00e93971e5ab07cd2aab4cb249a0ddcbdd069a83d24649050d939ae404991cfcd738b4e19d20d000512d7610f2aca020bab48c550cbed57196b07b1ba86f5b431d011f5093d263962a0946077720a5a0fbf4d4ea1e05f83147d41c4b09e9ef9a08b5c3eaa8b2300604cbaadb556c80cea0af7e4ef88868fd0b19c22ee339f77bc48df7861c95e397dbd5187382a53b4ea5a003f64402e8a2a7039fd70b4efaa6dfd62150b7d196bc5bfae9e5c8312ba3b2bfa00a62aa36eda182332a4bacc1156755f7d8e3d31d7ed8c2f6e00a99b19026b839a0402a1649c785ac8cc303100fee4a463dfefee0c8fa9fc6dced62ed1c3977fdd6a0ea718e7ed49c0f72914e9f5450fc79280496a6c0fdb1e5428f4546708e8541c0a05354e08b5b881ae51f6c6e1763e6afd5bcc7737c8b7339bc12a2c8f82320ed55a0db4aac62db2dc62967331737ce86d7be53305b9acc110ea21fbfff04a86d6cd4a0da3c01893043eba883124209448d708325fb68e51333d7251d4c38f2101a4d2fa07757ae4b9a18704f64d5905a8c5aa93e404364702252f8cc22c105462a9cf7c0a0fa8e9f7fd247bc87249afe3f25f02395a9b15b977faf8d2fe2e44dcf59e5cfefa0f8056760f23b5eb9fa26ae97fcea23ce219877b8f8cc3ab534237fa837220c33a01cbcfbcccd850a5578f086790e211867e83fdf966d68105feb591a415f4f796f80f90211a061a293f937efc5ba07be4786393b706a73f91fd2f76428f6f2049d82d61d5e5aa077e4cae27a5e73d9c2cefea1b0734b3333ccc6c2bdfca507b287a0d020f77364a00f8a03be2f999f859826a44d8c9df29a9dcd8d3cc3fe5994d3a6fadd23200366a07c0a23799856e863fefab7df1e59b96889ec2a3dbe2717e2e593afa392c6eba3a0fe91930bfba6f4aa1e9563e8836a119c8b0e57f91ea816d48c2bf8b633548f94a040d885af74792e0d3da574b4252aa381baca17cad269b8bd1c3ce4086576bc37a001c1ccbefd887bda647f106edadf19774d712f9f1f254da5080580349b4871fca0bcb8bf9062b56ca65ad3aef36c332cfe84b062a9c800f677ef8f4186e1c503d4a0c68f106edc71f9de158c2123f57dd61e1149ef889e190174ead2f7fb07dfc62fa0a1d6bc2751174d09ba589f5c9a7044da80f649def4ef5aaca989d5060e4a316ba09edc674e5495bb6cbb1667dd87437de502f7b442ddf7508e21ae969d949c1154a049eec4571432a2877f2b0fc3b2716fefa1a1aab92b7361a51eb32faa16413624a068ded0c820648219e674bd7fbf3c89a986c265e84dc34cbf8923e870f1840626a03f9b43d7c329ff6f2183e21b49916b8a29c7c580736b2cebd2114866b6968f60a094e82982b472da06ed5134d2a84be03f5071e0fca6e80fec3e51b422f6c6d40da06d1e16c2d5f6445b69d4490abc589432131381272864ad919cdd136c6be086ea80f90211a093181bdaddce9bdfe3aca6bef22089b177fab21d6a293cdcfa8bd8a0b5023e4da02be9b0edcfcd302a3ffe0ac6dc0abbce62472802fbbbb58601a3331926889133a0fad5f4c4e918284d54aedae7101e511e6957ff0ea57004507e3ccc2b7b8fe147a0792c045c1c9ec80c89700232b7daef1ee02e9d2b326d120da1aa261e519a8af3a097769fb7bd42db0ed2387f958dc81639085f8313da48c5e346b5a158e4a0db59a0727cedf499df4c1162534a12317279b2d8f6f48541549481bcf0ba7cc24e7d55a0030a8f35c8683b9d45416ec4996c700bdb1577d18f9990d1a4a6bc9e4f3bcee5a0255898d501a024340b97e93f96bb465d4b6059039bb699f27bfeb5fed81c16dba0ec2ce6eb12fbc3218d01cb20fa03a9cd30f10fd46379fd3271980501f62e06e5a0d0ac06af5658ba097c1d7fe28e4d7d9b0b1d4e8172d7ee3272f45132054b2e8aa0d44a51694b70df547bcfbd0363068bc908fc3a32663e268011607d0631e0a32ba0e657292f669136b4c9be296200466911a302fe5e9fce80102e0fab0cd86b0677a0fee728d489e337c36af5bb40887c9747a096eb87cea1233007b28bbe2367622fa09e6f561888dfdb234a0268bf8dae457b1c1a6ec90ca06c314c72ed043a75bcc0a0aa3a0cc29b027a19e5eb8c0361387d30af96dd84d7a9c64064f077e925f6b389a085d6279fe7e4169cd94ebe69adc8396799bf0b2660be819ff7076b18715070d680f90151a073dd408fc29be413006e60f3d60c1bcc313492db69c2c2fcbae62a04d70a6cbba0441a130e5b3344a0c6d4e01e69cdd8c3d54c9427c22df1c21e823bd5238bcedc80a0d7921037f60b8d14fadb7548b4a08207d7ddcc26d84eddb936dd62ca72498ebaa0616b1953ab56f21db0e3e0a8f04422bbdce75bd530e049560426deb7548c9324a0df7498a408a3cb6f416a60eb97bc61cdd31f9f9c1e3d9f2e131c476cca1a64aaa0b4b838d595815f1af27bc520f9054bbe7b8f1ae901d58ceba455a93a02b38fe3a088c2648a34b76ec09c67666bf1b2ff917c97a960dbebd2c8d56ec2b89c5f5d7ba080f002d80dc9f4e682660964f02c4f70fdfb5aeeee5f5651fca75c06f810c37980a0f6d68b8a203434af63aefd6acbce4e627b80e03c11d9c64334d48655f842ee24a02991191455c868799650d6cd4009a21443c9ac2aebedb76d55d9a01811d59a9c8080808080f8669d33269ec9b8f075a4723d27c611ac1c52a464f3516b25e0105a0d1c2210b846f8440180a02cd6bd673f33197205e0656bf034b073abf0695388a5dcd0e99cd3acddb61d60a02cfdfbdd943ec0153ed07b97f03eb765dc11cc79c6f750effcc2d126f93c4b31"
        );
    }

    function testCantVoteBeforeActivation() public {
        bytes32 id = bytes32(uint256(1));
        uint64 n = uint64(block.timestamp) + 10;
        governor.propose(
            id,
            IL1Governor.Proposal({
                snapshot: hex"d077c85d25408ee51a05118a39ccc8ab0ae80db65f60a18ea0209960bcfc9e4e",
                start: n,
                end: n + 100,
                executed: false,
                canceled: false
            })
        );

        ovm.warp(n);
        bytes
            memory proof = hex"f9076ef90211a0e15b776b5076420f42091e0ea52061a41b0532d661e56b9c650dd43326399154a0a54dd20d0ffa65778c2ac1b10dce946da7145db552f027484164ab49de67d70da0d284d5ef148e1cc2b69ffc5c48e405ea3fd2e80acf27f0693b53314fd7254edda09c687239a4d76e4d59f0dabd7560835b70a2ab557c07855669bf86db5b88d1cea077b763df13fdb49a5e2ee5bbd211f2b855082d4bdefe1bdce41ffd76baea2073a0d8d5593dcd25fb3760ee95079f833b1ebc7a2dc5bed83ea4645adfc2f37d06d5a0c946bdf3c83852f9b9dc9ef491bb7ce81dd3a2cc4400482c6b8ed448b0094aa4a0468ba9adb68ea7dc489eed78ab94007b7cb7a286ceaa8019c96bb354b8daf5c6a089cc7ebaea39fd716c1dc825999d14e14b3d0c4b77c72397a4044c3967a469b8a0b5fbe3d3c4728239bf67660307995d5fcdf2603d42c64b07180ead886537e413a066bda2b81151c0b3810708dbc6682807e9652677c562805602d9aefdf3c88142a087b8e2220b6ac3d43a88e21d795227ec189c533a36e39004a5d08f0853ebc7aca02fbf70d1641ccabc94043d33c3f373bfb51ec522eb78d3dd81abc5d8f099c0cba0aac43707cded10062968a2cd25beb01e58e757648faec4d475dc7674f2ad034ea0106aef93b0f5a0039f5e198cddbda380900ce922333fe9181a691039a392a61aa0a81bd92e037a831b5a760b88c6111c3025bb99281254838eb9bbf714ba40994e80f90211a0b7979f910ac0340ddd7affbf3fb61fc064a5f75c42403aa087dc491264e9a98da02a9a6ecf508902655d2e6cf11744227ec5cb8a87d22cbf6134a059c0d031f8b3a04f419926ed4e13fb775e402c4b424882097ecdc96af7ad61c589acb71106f376a049131409b8941928e6fee322cb0f68ed40e2be684e059a64ef12b35eea21a227a0171d14f9816848ac1276e9b3752c944dce304616adf62c472b6386313ab024e3a02ae9c09c6273053b6c301d3a56f03ab19c4cd936b20ab3bf1e45e6eea97c5109a0e6f2c24b7840299c0858fdef707cbd73835b9c279a6401f9b0328ed2516d538ba0a6fce4426f5e6e8738862d38ff5b54ea4d8aae00775d444953dd23f867b7f986a06ff69012182563f320eee59a71ce99bc1ee04ccc9020eefb324ae85dd2941432a07c51c45a61470166ec76b4dae619d72561b0d1a8ca434564fc3a5ad2d7610c9aa0dcff68893fd23350e261652d9aea868b20d957f87cdc4a4f5979e20456c2e6e3a05930aec794b1d919962e13b1004715d8889903132f052b4357fdb264327d5bb9a0404f097a57bfe49c9685cc904f8c45dff271c7e0c43c98fc15ff5424aa7bb3c1a0739c2f3ea4839db1a0445f6d229cb59298a0eeca8e2dad0a0eca5beff69c2b4da0341a5497d43ca3d30eaa0fa119f3f5005dfe4ba7b8beb15815cdf7a3b861839ea019f7e661e03121bfc7a539e34d630ed7a90c7e9b3f9cac0f1888191f1d270b1080f90211a0240bf8715ba386c0857f5f66a7f4939f9dd03ce18e34b303cd5f00fc88bb26daa0632775b40d10c8354e6e9850ceb13805b38ef9013c103c76227fb73115bb97eaa00dfea5ae9f9de2b4f2b52bed302059e24abcd9cabfdddd57cdffa2dd3ab0fe5ba0b3674622b3f65635dc588cde4d3ae8c970af51c4e26633579ef3490cd1685f14a0428ad6652dde51b57f14839794fa3e40150a882868a2671a08650a77eb6bf381a0fe10b847711504937c88f350339de028c3554c2a89ceea6a546374ae8c2b3904a0f5817055ef9dda4ed831bfd1bdf5dadf0cf5628934cd01de22b2971b51c80bd3a0627daa0717c8c952f39dcdb0f1080233611d10ff2e65cbec32c709abccbb2661a0a91299e08e2080cea8a99316eebfc165673de9f1df78b136c66c43cfa2591974a0e34bf7636bf24cf00f6b270558f80b3b10d0268297d22cda66c767fc482e0c73a0ddbcd9c49c160c892d78051533d15df32357bf775a4a7e098f787fc3fc61d539a0d1529a51b5d1d2c95c6e832e89caa446b450145dc6c1b357ed3c06b365cd2198a03c618cd96a3c71fc0927bd462a28fa283d417740a310e69538dccb059e0229f9a0c1d3491683680579a1158563e902b5b42142f63e27542c17c34fc558afe0e13ba0f98d4e726ab20c57c5a481eb678dffeb6f94fdd3f45241a13378417a1a15db8fa01a1527c2a6bd7fec49a0085db66c9a215f4403f733f8a5e1fb8fdb2dd04d409e80f8b180808080a0119828a6928210218e9c7625eba53d0600fad1159648ed2333d0b30960c3b123a03c30738990fee2cf2b29589f0b1d53a9b68726a5067d71a1f361845184d0335f808080a036760b66a7d36a9a01969270b95326e9889ea10c106d4cdf796dba6fc1d936db808080a0f1f2bcf80ca5c91e4454b84c340e4089eb395dc995e55e4ef56b29ea1a57db8480a05b66122fed950f85b73218189230ffc9aa391682e19b19015630dc49af9f26cd80f8518080808080a0d87e0b2631f38d6e542df219ee5387e2969dfd016aeaaeb4848c39307b6d2c9a80808080a0046e88e9040d65df7376671c0a695cded7d47bd552dd9cf39c3596b41d97a2e1808080808080eb9e34675593a2afa8fe1ff3e09eaa5b961bbb9be0bca4f89c6f3e3b75c558948b8a9a6c877477891cc6cfac";

        vm.startPrank(0xba740c9035fF3c24A69e0df231149c9cd12BAe07);

        vm.expectRevert("rollcall: account doesnt exist");
        voter.castVote(
            id,
            0x7aE1D57b58fA6411F32948314BadD83583eE0e8C,
            address(governor),
            proof,
            1
        );
    }

    // function testCantProposeWhenAfterEnd() public {
    //     uint64 ts = uint64(block.timestamp);
    //     vm.warp(block.timestamp + 101);
    //     vm.expectRevert("bridge: proposal end before now");
    //     governor.propose(
    //         1,
    //         IL1Governor.Proposal({
    //             snapshot: blockhash(block.number),
    //             root: hex"4d65424d564e39f92e231c095100877ebe8bac54776632b75be295d983746127",
    //             start: ts,
    //             end: ts + 100,
    //             executed: false,
    //             canceled: false
    //         })
    //     );
    // }
}

contract L2Voter_State is L2VoterSetup {
    bytes32 private id = bytes32(uint256(1));
    uint64 internal bn = uint64(block.timestamp);
    uint64 internal start = bn + 10;
    uint64 internal end = bn + 100;

    function setUp() public override {
        super.setUp();

        governor.propose(
            bytes32(uint256(1)),
            IL1Governor.Proposal({
                snapshot: blockhash(block.number),
                start: start,
                end: end,
                executed: false,
                canceled: false
            })
        );
    }

    function testReturnsCorrectProposalState() public {
        ovm.warp(1);
        assertEq(
            uint256(voter.state(address(governor), id)),
            uint256(IL2Voter.ProposalState.Pending),
            "proposal not pending"
        );

        ovm.warp(start);
        assertEq(
            uint256(voter.state(address(governor), id)),
            uint256(IL2Voter.ProposalState.Active),
            "proposal not active"
        );

        ovm.warp(end);
        assertEq(
            uint256(voter.state(address(governor), id)),
            uint256(IL2Voter.ProposalState.Ended)
        );

        voter.queue(address(governor), id, 1e6);
        assertEq(
            uint256(voter.state(address(governor), id)),
            uint256(IL2Voter.ProposalState.Queued)
        );

        vm.expectRevert("rollcall: proposal vote doesnt exist");
        voter.state(address(governor), bytes32(uint256(2)));
    }
}

contract L2Voter_Voting is L2VoterSetup {
    bytes32 private id = bytes32(uint256(1));
    uint64 internal bn = uint64(block.number);
    uint64 internal start = bn + 10;
    uint64 internal end = bn + 100;

    function setUp() public override {
        super.setUp();

        ovm.warp(block.number);

        governor.propose(
            id,
            IL1Governor.Proposal({
                snapshot: hex"d077c85d25408ee51a05118a39ccc8ab0ae80db65f60a18ea0209960bcfc9e4e",
                start: start,
                end: end,
                executed: false,
                canceled: false
            })
        );

        voter.activate(
            address(governor),
            id,
            hex"f90215a06c677c79f07249f5af85156dc66a33c2d1a2e843ab1ce80f953d0079e780587da01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d493479452bc44d5378309ee2abf1539bf71de1b7d7be3b5a04d65424d564e39f92e231c095100877ebe8bac54776632b75be295d983746127a0a96cac5b975d6c89c3ffb148cf76088be45810ae7950993bcf40a899282a628fa042402e593d83815dda04b367c05dc9bee01b61e9746a05182f2e0537853a5185b90100fd7eee26d7d73ef5f9ac35fdeebd9beddfb878fda816feb8ea97b35937fadfbbb35509fee6ff4ededf5d7fcce25f9952feadfd5ffd7bfdbdbe7e98fc3fbbf3eb3cedcf9797bab5eb5bcbfebeeb3abbf38ef2b437f5d9bbd7bff73f79a07391533f1792b5cf7f5bb59dd435fbede2f9f374f98bb802ff3d5457dcdf52fed8595dff7ee7fa46c3b53fea4b8df1fbf6cae77fed14d7db93b7fd7fa3a4dfeef57936f3dbff1d9e9327f6deb747d6edb517716bc4dbedb77b6a7fe1e2beee3df99455f52cfeef8fff5ff5f3550fe65eebcba7ad694febdfab6f132cfadfbebf632674edbf68ffd311faf02ffeb6e1d1af2ceb47ede9fdf3ebbf6db977f9bfd58bf77f872b1e4e28cf0a9083d4a0048401c9c3808401c9afa08461d358fe8c6e616e6f706f6f6c2e6f7267a0959d62b6259bb2b4fc37375c5c41496c8af646b1248827088b61742fcc8fc567883aabff9550735bc7851cbc487a76",
            hex"f90e37f90e34f90211a0ace0683393fa65a836500367726de537eaf01c0144167cbc683677c96ba8df42a0d78f99814dbc434189a56d14df9dc8f4ab0ef747f2da2e1f30cc72eff8dcf86ca0c885caabd49f5acab72455ec405ff166e889aab046c01e3afe10492649c72334a08f8fa912744fe7d1f33088034e7cb75a2e61313fc59e0d33b2dc5ead96fc3e1aa024da5f344ca4809a38cb6098fb1db76ecedfed033775315594dc446c8a409b5aa05f3202c834b6a346cb647a7352e49f01003e44e63536680120e269ce30d04ab7a0fd7df6d8b821ee6623651b7242e59db0fce86bbe36a1627aa59c74ecedb75b85a0d26cc5fad9973b4610b5711847330359e7bce938c8edbb64c0d41a060e0357f5a003757d01388b256af41e384b37a90eac3d396c359125e7f3de7dd959fd417f46a0774916a1f706db63a9f3894682dcc66811aac05aa99bd98cad6445475c1e5606a0bf3c129eb79cc7dfe7349f8f4a7d13cff3def1185e967ecc671c932976986394a0784433c64bd71e32144983e961c45ccadb67c58d990c97af4a773f04198daf12a0e2d3456b9ac2cf404e7e802e6b992d022484eb03f12058973f7702f2dc0c5c75a0538f488cf68a51e6ec8744bb3b63f6be3d7397fe9a97d7b294ac6275ebd0c710a023cdb85019317522b83194468054bdc3f8b4b25561294908c741b0b5c0f6459ea0da62084f1ce9d271f37fb2b4e921cc0d8aa4be3f40d86574286b2b6c83a5373080f90211a050ef96a9d0214264a728fb72aacd0117359359b2593a23a4c3ea11f4e9a94ef6a048fd38c578b2bc35f37b96e7f6a09b29378f2e7259b04d0ee546e9e72b51620aa01cb98cc6018dc16bc002a1ebadb9650e9bb20eae4114bda552beb511e18ca188a00613ad5dc585e8fdb1c585b9e7b061cbdb86a3b888665f9e74cec6d6fddc2fbea0d302ef04ccbb0be012de45ea55c5022f94f3419fadcabb3546dd8c07befb4e35a007adcf416194b65efa11b40683c564a0a8910b14b1ee1dcefd16aa6e88488715a09f1c78a7bb8f1dfed06d646e5a5be4c94b0a05c2584616db445a4e07d928a63ea0e2bc7b885dc0e7d59b38c004dc0b9f8fd2856d6b3caf5565ee0b8f607abeb3e8a0640562342b8842137ec7a836ee845f33ac569c01f2e4369db67eddc68f78b43da0f89330885daf7742939734cff2872cb91a297fd980a956d6de6e2d7d1d14c543a084331284a7ca49e823bd79208b2ea477cf025950f95085a2511f2f0721bf559da0d4d0bf57f17176d1ab6ea91f654c14acc5c2236ddccbc2ff596d8d96612611b2a02917bd1ffe56666efa5918930b131e29cf31113e51112a2569843d89e1ebc667a016a6d4af52dda35added8e58f0a0312c49fdab14caa84695dc003219541a7b16a03d73a06b5355a287887e3b17cfdae97754b7572189d6597a2b5f426cc2efd642a0a689e73b53a22048748d240a04caab3a92b24aa13e50d243968d14ea4761a44480f90211a0be56858fbdebdb81b95067017ddc33ceb9e32df1fd4862ece8940336ae744dc0a0e5243274228eb856c3c4fcab9ff34ffafe236f044f9ed8250262149f37e4e9faa0d7e5fccfc58ab4a86e1ad8aafd7586cbd6c5f52c48b46e8500c106f88cbf6660a054210e8b00ebf19ccfec880c04e475e8a05f5af17c072bda449f89c78cfadaf4a0fc2fd481b6569015dcc136c3afe1e67831d77ffc20a2ba614e6dd49d3e52cb6fa0dc088781c0596a64cf9fd7ceaa6bf906cad1150b248449836a411a5a929da5c5a0e01313b2738360d14a03ae5a20d562a643c644895533e364b00bb010b00898eda095e06e228fd36cc2878ece64defabc384ea9c891be3dd0210260285c7f5c5727a000d7a2b9a8700db743a58f529df4f618732928809b9c30274faac304507de28ba07a60ebccbda505d3763b07acbd8b0c07cf21196bc69dadd2e0101f708c0fa0caa0030a2cd41a46333dc9f6a80db1b1c411bbbc8c67cb0553c733b01ff7947f4722a0795176c823536428f7483857aed4960e7ffb2aa542adb62f214382eab4202de1a07523340d574fb04a8e79510a0b8af8aebfcbd948e69e3426dab0994f5b33fa47a05b14bb5df540a2db54501dc0976899879fb379fcd930c3082e7008393871d016a05e40cb28bf4679e4452272b5507b8987223a1472e7d292d94b9f39edb940c31da04457ad4c9d7395dcd8a34167bcc0186546554f856faa47ef3a8f42030cb93d8180f90211a0293fc33d0a7ae73581abde554f48182a64e29e00e93971e5ab07cd2aab4cb249a0ddcbdd069a83d24649050d939ae404991cfcd738b4e19d20d000512d7610f2aca020bab48c550cbed57196b07b1ba86f5b431d011f5093d263962a0946077720a5a0fbf4d4ea1e05f83147d41c4b09e9ef9a08b5c3eaa8b2300604cbaadb556c80cea0af7e4ef88868fd0b19c22ee339f77bc48df7861c95e397dbd5187382a53b4ea5a003f64402e8a2a7039fd70b4efaa6dfd62150b7d196bc5bfae9e5c8312ba3b2bfa00a62aa36eda182332a4bacc1156755f7d8e3d31d7ed8c2f6e00a99b19026b839a0402a1649c785ac8cc303100fee4a463dfefee0c8fa9fc6dced62ed1c3977fdd6a0ea718e7ed49c0f72914e9f5450fc79280496a6c0fdb1e5428f4546708e8541c0a05354e08b5b881ae51f6c6e1763e6afd5bcc7737c8b7339bc12a2c8f82320ed55a0db4aac62db2dc62967331737ce86d7be53305b9acc110ea21fbfff04a86d6cd4a0da3c01893043eba883124209448d708325fb68e51333d7251d4c38f2101a4d2fa07757ae4b9a18704f64d5905a8c5aa93e404364702252f8cc22c105462a9cf7c0a0fa8e9f7fd247bc87249afe3f25f02395a9b15b977faf8d2fe2e44dcf59e5cfefa0f8056760f23b5eb9fa26ae97fcea23ce219877b8f8cc3ab534237fa837220c33a01cbcfbcccd850a5578f086790e211867e83fdf966d68105feb591a415f4f796f80f90211a061a293f937efc5ba07be4786393b706a73f91fd2f76428f6f2049d82d61d5e5aa077e4cae27a5e73d9c2cefea1b0734b3333ccc6c2bdfca507b287a0d020f77364a00f8a03be2f999f859826a44d8c9df29a9dcd8d3cc3fe5994d3a6fadd23200366a07c0a23799856e863fefab7df1e59b96889ec2a3dbe2717e2e593afa392c6eba3a0fe91930bfba6f4aa1e9563e8836a119c8b0e57f91ea816d48c2bf8b633548f94a040d885af74792e0d3da574b4252aa381baca17cad269b8bd1c3ce4086576bc37a001c1ccbefd887bda647f106edadf19774d712f9f1f254da5080580349b4871fca0bcb8bf9062b56ca65ad3aef36c332cfe84b062a9c800f677ef8f4186e1c503d4a0c68f106edc71f9de158c2123f57dd61e1149ef889e190174ead2f7fb07dfc62fa0a1d6bc2751174d09ba589f5c9a7044da80f649def4ef5aaca989d5060e4a316ba09edc674e5495bb6cbb1667dd87437de502f7b442ddf7508e21ae969d949c1154a049eec4571432a2877f2b0fc3b2716fefa1a1aab92b7361a51eb32faa16413624a068ded0c820648219e674bd7fbf3c89a986c265e84dc34cbf8923e870f1840626a03f9b43d7c329ff6f2183e21b49916b8a29c7c580736b2cebd2114866b6968f60a094e82982b472da06ed5134d2a84be03f5071e0fca6e80fec3e51b422f6c6d40da06d1e16c2d5f6445b69d4490abc589432131381272864ad919cdd136c6be086ea80f90211a093181bdaddce9bdfe3aca6bef22089b177fab21d6a293cdcfa8bd8a0b5023e4da02be9b0edcfcd302a3ffe0ac6dc0abbce62472802fbbbb58601a3331926889133a0fad5f4c4e918284d54aedae7101e511e6957ff0ea57004507e3ccc2b7b8fe147a0792c045c1c9ec80c89700232b7daef1ee02e9d2b326d120da1aa261e519a8af3a097769fb7bd42db0ed2387f958dc81639085f8313da48c5e346b5a158e4a0db59a0727cedf499df4c1162534a12317279b2d8f6f48541549481bcf0ba7cc24e7d55a0030a8f35c8683b9d45416ec4996c700bdb1577d18f9990d1a4a6bc9e4f3bcee5a0255898d501a024340b97e93f96bb465d4b6059039bb699f27bfeb5fed81c16dba0ec2ce6eb12fbc3218d01cb20fa03a9cd30f10fd46379fd3271980501f62e06e5a0d0ac06af5658ba097c1d7fe28e4d7d9b0b1d4e8172d7ee3272f45132054b2e8aa0d44a51694b70df547bcfbd0363068bc908fc3a32663e268011607d0631e0a32ba0e657292f669136b4c9be296200466911a302fe5e9fce80102e0fab0cd86b0677a0fee728d489e337c36af5bb40887c9747a096eb87cea1233007b28bbe2367622fa09e6f561888dfdb234a0268bf8dae457b1c1a6ec90ca06c314c72ed043a75bcc0a0aa3a0cc29b027a19e5eb8c0361387d30af96dd84d7a9c64064f077e925f6b389a085d6279fe7e4169cd94ebe69adc8396799bf0b2660be819ff7076b18715070d680f90151a073dd408fc29be413006e60f3d60c1bcc313492db69c2c2fcbae62a04d70a6cbba0441a130e5b3344a0c6d4e01e69cdd8c3d54c9427c22df1c21e823bd5238bcedc80a0d7921037f60b8d14fadb7548b4a08207d7ddcc26d84eddb936dd62ca72498ebaa0616b1953ab56f21db0e3e0a8f04422bbdce75bd530e049560426deb7548c9324a0df7498a408a3cb6f416a60eb97bc61cdd31f9f9c1e3d9f2e131c476cca1a64aaa0b4b838d595815f1af27bc520f9054bbe7b8f1ae901d58ceba455a93a02b38fe3a088c2648a34b76ec09c67666bf1b2ff917c97a960dbebd2c8d56ec2b89c5f5d7ba080f002d80dc9f4e682660964f02c4f70fdfb5aeeee5f5651fca75c06f810c37980a0f6d68b8a203434af63aefd6acbce4e627b80e03c11d9c64334d48655f842ee24a02991191455c868799650d6cd4009a21443c9ac2aebedb76d55d9a01811d59a9c8080808080f8669d33269ec9b8f075a4723d27c611ac1c52a464f3516b25e0105a0d1c2210b846f8440180a02cd6bd673f33197205e0656bf034b073abf0695388a5dcd0e99cd3acddb61d60a02cfdfbdd943ec0153ed07b97f03eb765dc11cc79c6f750effcc2d126f93c4b31"
        );
    }

    function testProposalState() public {
        L2Voter.Proposal memory proposal = voter.proposal(
            address(governor),
            id
        );

        assertEq(
            proposal.stateroot,
            hex"4d65424d564e39f92e231c095100877ebe8bac54776632b75be295d983746127",
            "root doesnt match"
        );

        assertEq(uint256(proposal.start), uint256(start), "start doesnt match");
        assertEq(uint256(proposal.end), uint256(end), "end doesnt match");
        assertTrue(!proposal.queue, "queue doesnt match");
    }

    function testCastVote() public {
        ovm.warp(start);
        bytes
            memory proof = hex"f9076ef90211a0e15b776b5076420f42091e0ea52061a41b0532d661e56b9c650dd43326399154a0a54dd20d0ffa65778c2ac1b10dce946da7145db552f027484164ab49de67d70da0d284d5ef148e1cc2b69ffc5c48e405ea3fd2e80acf27f0693b53314fd7254edda09c687239a4d76e4d59f0dabd7560835b70a2ab557c07855669bf86db5b88d1cea077b763df13fdb49a5e2ee5bbd211f2b855082d4bdefe1bdce41ffd76baea2073a0d8d5593dcd25fb3760ee95079f833b1ebc7a2dc5bed83ea4645adfc2f37d06d5a0c946bdf3c83852f9b9dc9ef491bb7ce81dd3a2cc4400482c6b8ed448b0094aa4a0468ba9adb68ea7dc489eed78ab94007b7cb7a286ceaa8019c96bb354b8daf5c6a089cc7ebaea39fd716c1dc825999d14e14b3d0c4b77c72397a4044c3967a469b8a0b5fbe3d3c4728239bf67660307995d5fcdf2603d42c64b07180ead886537e413a066bda2b81151c0b3810708dbc6682807e9652677c562805602d9aefdf3c88142a087b8e2220b6ac3d43a88e21d795227ec189c533a36e39004a5d08f0853ebc7aca02fbf70d1641ccabc94043d33c3f373bfb51ec522eb78d3dd81abc5d8f099c0cba0aac43707cded10062968a2cd25beb01e58e757648faec4d475dc7674f2ad034ea0106aef93b0f5a0039f5e198cddbda380900ce922333fe9181a691039a392a61aa0a81bd92e037a831b5a760b88c6111c3025bb99281254838eb9bbf714ba40994e80f90211a0b7979f910ac0340ddd7affbf3fb61fc064a5f75c42403aa087dc491264e9a98da02a9a6ecf508902655d2e6cf11744227ec5cb8a87d22cbf6134a059c0d031f8b3a04f419926ed4e13fb775e402c4b424882097ecdc96af7ad61c589acb71106f376a049131409b8941928e6fee322cb0f68ed40e2be684e059a64ef12b35eea21a227a0171d14f9816848ac1276e9b3752c944dce304616adf62c472b6386313ab024e3a02ae9c09c6273053b6c301d3a56f03ab19c4cd936b20ab3bf1e45e6eea97c5109a0e6f2c24b7840299c0858fdef707cbd73835b9c279a6401f9b0328ed2516d538ba0a6fce4426f5e6e8738862d38ff5b54ea4d8aae00775d444953dd23f867b7f986a06ff69012182563f320eee59a71ce99bc1ee04ccc9020eefb324ae85dd2941432a07c51c45a61470166ec76b4dae619d72561b0d1a8ca434564fc3a5ad2d7610c9aa0dcff68893fd23350e261652d9aea868b20d957f87cdc4a4f5979e20456c2e6e3a05930aec794b1d919962e13b1004715d8889903132f052b4357fdb264327d5bb9a0404f097a57bfe49c9685cc904f8c45dff271c7e0c43c98fc15ff5424aa7bb3c1a0739c2f3ea4839db1a0445f6d229cb59298a0eeca8e2dad0a0eca5beff69c2b4da0341a5497d43ca3d30eaa0fa119f3f5005dfe4ba7b8beb15815cdf7a3b861839ea019f7e661e03121bfc7a539e34d630ed7a90c7e9b3f9cac0f1888191f1d270b1080f90211a0240bf8715ba386c0857f5f66a7f4939f9dd03ce18e34b303cd5f00fc88bb26daa0632775b40d10c8354e6e9850ceb13805b38ef9013c103c76227fb73115bb97eaa00dfea5ae9f9de2b4f2b52bed302059e24abcd9cabfdddd57cdffa2dd3ab0fe5ba0b3674622b3f65635dc588cde4d3ae8c970af51c4e26633579ef3490cd1685f14a0428ad6652dde51b57f14839794fa3e40150a882868a2671a08650a77eb6bf381a0fe10b847711504937c88f350339de028c3554c2a89ceea6a546374ae8c2b3904a0f5817055ef9dda4ed831bfd1bdf5dadf0cf5628934cd01de22b2971b51c80bd3a0627daa0717c8c952f39dcdb0f1080233611d10ff2e65cbec32c709abccbb2661a0a91299e08e2080cea8a99316eebfc165673de9f1df78b136c66c43cfa2591974a0e34bf7636bf24cf00f6b270558f80b3b10d0268297d22cda66c767fc482e0c73a0ddbcd9c49c160c892d78051533d15df32357bf775a4a7e098f787fc3fc61d539a0d1529a51b5d1d2c95c6e832e89caa446b450145dc6c1b357ed3c06b365cd2198a03c618cd96a3c71fc0927bd462a28fa283d417740a310e69538dccb059e0229f9a0c1d3491683680579a1158563e902b5b42142f63e27542c17c34fc558afe0e13ba0f98d4e726ab20c57c5a481eb678dffeb6f94fdd3f45241a13378417a1a15db8fa01a1527c2a6bd7fec49a0085db66c9a215f4403f733f8a5e1fb8fdb2dd04d409e80f8b180808080a0119828a6928210218e9c7625eba53d0600fad1159648ed2333d0b30960c3b123a03c30738990fee2cf2b29589f0b1d53a9b68726a5067d71a1f361845184d0335f808080a036760b66a7d36a9a01969270b95326e9889ea10c106d4cdf796dba6fc1d936db808080a0f1f2bcf80ca5c91e4454b84c340e4089eb395dc995e55e4ef56b29ea1a57db8480a05b66122fed950f85b73218189230ffc9aa391682e19b19015630dc49af9f26cd80f8518080808080a0d87e0b2631f38d6e542df219ee5387e2969dfd016aeaaeb4848c39307b6d2c9a80808080a0046e88e9040d65df7376671c0a695cded7d47bd552dd9cf39c3596b41d97a2e1808080808080eb9e34675593a2afa8fe1ff3e09eaa5b961bbb9be0bca4f89c6f3e3b75c558948b8a9a6c877477891cc6cfac";

        vm.startPrank(0xba740c9035fF3c24A69e0df231149c9cd12BAe07);
        assertEq(
            voter.castVote(
                id,
                0x7aE1D57b58fA6411F32948314BadD83583eE0e8C,
                address(governor),
                proof,
                1
            ),
            729246447279609190207404,
            "incorrect balance"
        );
    }

    function testCastVoteWithReason() public {
        ovm.warp(start);
        bytes
            memory proof = hex"f9076ef90211a0e15b776b5076420f42091e0ea52061a41b0532d661e56b9c650dd43326399154a0a54dd20d0ffa65778c2ac1b10dce946da7145db552f027484164ab49de67d70da0d284d5ef148e1cc2b69ffc5c48e405ea3fd2e80acf27f0693b53314fd7254edda09c687239a4d76e4d59f0dabd7560835b70a2ab557c07855669bf86db5b88d1cea077b763df13fdb49a5e2ee5bbd211f2b855082d4bdefe1bdce41ffd76baea2073a0d8d5593dcd25fb3760ee95079f833b1ebc7a2dc5bed83ea4645adfc2f37d06d5a0c946bdf3c83852f9b9dc9ef491bb7ce81dd3a2cc4400482c6b8ed448b0094aa4a0468ba9adb68ea7dc489eed78ab94007b7cb7a286ceaa8019c96bb354b8daf5c6a089cc7ebaea39fd716c1dc825999d14e14b3d0c4b77c72397a4044c3967a469b8a0b5fbe3d3c4728239bf67660307995d5fcdf2603d42c64b07180ead886537e413a066bda2b81151c0b3810708dbc6682807e9652677c562805602d9aefdf3c88142a087b8e2220b6ac3d43a88e21d795227ec189c533a36e39004a5d08f0853ebc7aca02fbf70d1641ccabc94043d33c3f373bfb51ec522eb78d3dd81abc5d8f099c0cba0aac43707cded10062968a2cd25beb01e58e757648faec4d475dc7674f2ad034ea0106aef93b0f5a0039f5e198cddbda380900ce922333fe9181a691039a392a61aa0a81bd92e037a831b5a760b88c6111c3025bb99281254838eb9bbf714ba40994e80f90211a0b7979f910ac0340ddd7affbf3fb61fc064a5f75c42403aa087dc491264e9a98da02a9a6ecf508902655d2e6cf11744227ec5cb8a87d22cbf6134a059c0d031f8b3a04f419926ed4e13fb775e402c4b424882097ecdc96af7ad61c589acb71106f376a049131409b8941928e6fee322cb0f68ed40e2be684e059a64ef12b35eea21a227a0171d14f9816848ac1276e9b3752c944dce304616adf62c472b6386313ab024e3a02ae9c09c6273053b6c301d3a56f03ab19c4cd936b20ab3bf1e45e6eea97c5109a0e6f2c24b7840299c0858fdef707cbd73835b9c279a6401f9b0328ed2516d538ba0a6fce4426f5e6e8738862d38ff5b54ea4d8aae00775d444953dd23f867b7f986a06ff69012182563f320eee59a71ce99bc1ee04ccc9020eefb324ae85dd2941432a07c51c45a61470166ec76b4dae619d72561b0d1a8ca434564fc3a5ad2d7610c9aa0dcff68893fd23350e261652d9aea868b20d957f87cdc4a4f5979e20456c2e6e3a05930aec794b1d919962e13b1004715d8889903132f052b4357fdb264327d5bb9a0404f097a57bfe49c9685cc904f8c45dff271c7e0c43c98fc15ff5424aa7bb3c1a0739c2f3ea4839db1a0445f6d229cb59298a0eeca8e2dad0a0eca5beff69c2b4da0341a5497d43ca3d30eaa0fa119f3f5005dfe4ba7b8beb15815cdf7a3b861839ea019f7e661e03121bfc7a539e34d630ed7a90c7e9b3f9cac0f1888191f1d270b1080f90211a0240bf8715ba386c0857f5f66a7f4939f9dd03ce18e34b303cd5f00fc88bb26daa0632775b40d10c8354e6e9850ceb13805b38ef9013c103c76227fb73115bb97eaa00dfea5ae9f9de2b4f2b52bed302059e24abcd9cabfdddd57cdffa2dd3ab0fe5ba0b3674622b3f65635dc588cde4d3ae8c970af51c4e26633579ef3490cd1685f14a0428ad6652dde51b57f14839794fa3e40150a882868a2671a08650a77eb6bf381a0fe10b847711504937c88f350339de028c3554c2a89ceea6a546374ae8c2b3904a0f5817055ef9dda4ed831bfd1bdf5dadf0cf5628934cd01de22b2971b51c80bd3a0627daa0717c8c952f39dcdb0f1080233611d10ff2e65cbec32c709abccbb2661a0a91299e08e2080cea8a99316eebfc165673de9f1df78b136c66c43cfa2591974a0e34bf7636bf24cf00f6b270558f80b3b10d0268297d22cda66c767fc482e0c73a0ddbcd9c49c160c892d78051533d15df32357bf775a4a7e098f787fc3fc61d539a0d1529a51b5d1d2c95c6e832e89caa446b450145dc6c1b357ed3c06b365cd2198a03c618cd96a3c71fc0927bd462a28fa283d417740a310e69538dccb059e0229f9a0c1d3491683680579a1158563e902b5b42142f63e27542c17c34fc558afe0e13ba0f98d4e726ab20c57c5a481eb678dffeb6f94fdd3f45241a13378417a1a15db8fa01a1527c2a6bd7fec49a0085db66c9a215f4403f733f8a5e1fb8fdb2dd04d409e80f8b180808080a0119828a6928210218e9c7625eba53d0600fad1159648ed2333d0b30960c3b123a03c30738990fee2cf2b29589f0b1d53a9b68726a5067d71a1f361845184d0335f808080a036760b66a7d36a9a01969270b95326e9889ea10c106d4cdf796dba6fc1d936db808080a0f1f2bcf80ca5c91e4454b84c340e4089eb395dc995e55e4ef56b29ea1a57db8480a05b66122fed950f85b73218189230ffc9aa391682e19b19015630dc49af9f26cd80f8518080808080a0d87e0b2631f38d6e542df219ee5387e2969dfd016aeaaeb4848c39307b6d2c9a80808080a0046e88e9040d65df7376671c0a695cded7d47bd552dd9cf39c3596b41d97a2e1808080808080eb9e34675593a2afa8fe1ff3e09eaa5b961bbb9be0bca4f89c6f3e3b75c558948b8a9a6c877477891cc6cfac";

        vm.startPrank(0xba740c9035fF3c24A69e0df231149c9cd12BAe07);
        assertEq(
            voter.castVoteWithReason(
                id,
                0x7aE1D57b58fA6411F32948314BadD83583eE0e8C,
                address(governor),
                proof,
                1,
                "I love this"
            ),
            729246447279609190207404,
            "incorrect balance"
        );
    }

    function testCastVoteBySig() public {
        uint8 support = 1;

        ovm.warp(start);
        bytes
            memory proof = hex"f907adf90211a0e15b776b5076420f42091e0ea52061a41b0532d661e56b9c650dd43326399154a0a54dd20d0ffa65778c2ac1b10dce946da7145db552f027484164ab49de67d70da0d284d5ef148e1cc2b69ffc5c48e405ea3fd2e80acf27f0693b53314fd7254edda09c687239a4d76e4d59f0dabd7560835b70a2ab557c07855669bf86db5b88d1cea077b763df13fdb49a5e2ee5bbd211f2b855082d4bdefe1bdce41ffd76baea2073a0d8d5593dcd25fb3760ee95079f833b1ebc7a2dc5bed83ea4645adfc2f37d06d5a0c946bdf3c83852f9b9dc9ef491bb7ce81dd3a2cc4400482c6b8ed448b0094aa4a0468ba9adb68ea7dc489eed78ab94007b7cb7a286ceaa8019c96bb354b8daf5c6a089cc7ebaea39fd716c1dc825999d14e14b3d0c4b77c72397a4044c3967a469b8a0b5fbe3d3c4728239bf67660307995d5fcdf2603d42c64b07180ead886537e413a066bda2b81151c0b3810708dbc6682807e9652677c562805602d9aefdf3c88142a087b8e2220b6ac3d43a88e21d795227ec189c533a36e39004a5d08f0853ebc7aca02fbf70d1641ccabc94043d33c3f373bfb51ec522eb78d3dd81abc5d8f099c0cba0aac43707cded10062968a2cd25beb01e58e757648faec4d475dc7674f2ad034ea0106aef93b0f5a0039f5e198cddbda380900ce922333fe9181a691039a392a61aa0a81bd92e037a831b5a760b88c6111c3025bb99281254838eb9bbf714ba40994e80f90211a01dbfcc4dd63c3bec098ff79d1227ab345cbd93502dcdb4af5a8f1dfb3ee177e3a0b0b0eb22b162816c4d2fd5741eb53578322885660fd26d2e6f87027b3f9889c2a0f29afa54770a78330d2b97101b7ddc94ff7e174d0fc9a7c2479b77447601bdb2a087a07bd82c2d5d33500a2b168572128c025ebab522c382e06496b37b652290d3a07f6e3ac56f89dc9c6e43315ed50d7b029d668464ce2de89b3a4cebb706d5e117a0e4ec792e15b18ae9bbd17d36e0657ca90f5419407097eb0ab80b4d3be01f364ba053619f7e92c3cbb79a8bdeaee017d6bb2169bee1d539ddd81fe63d139f89e943a0cac46da8be63d561cfc6db05b8121bde08c0cc4467cde35a5bebbb97d00d6258a02203b3b2216083ca7658534c85116a8757f77e02b3af26b3a78bcd5a0fc97dffa09d4902b161a9d541fb937d8434e6b03d41c74e3b31b144cb8ecab0b40beab5a9a020841a37da3719a471fde97f0d950af67a538ffbec5e1b0d1d0bf015507588e4a07e281ba53fe6f7bb1c8e8cc64c8bf2f4d72815283ae667885bfea98605027d33a098deebdff1fc32c54eb3067318af04cf509e4abd63118e34015c7755d77cc14da0051aaaeb0031efa4cb862bedcf8714dd857d8b57971e1d996b013c7783de3ebca0f0f15cc59d5ab304df04f1d51f799d95e84baa80f8208c2aa3b1690cec17d986a042024d6346497dbdc6d079f9f07203e0cb7f0464c1367bde55600f367269925c80f90211a0ec55eb7e06242c0f2c104c44c8a61cc0f80e5e3c7cd7a8424a6f308490e66d49a0cea611f186649c6dabd93cdf974e6bd9d63b5fbab5c7945e89e9c8c88be9701da0324d3e47145a1b595a8b50301b1ef798c0b2f86291b58298c7306aac976ea0b8a087205b47684283ff9cab00870a56d6be2c1c9e0986397a73e348dea1db64a31da03f292ec73ba53f56eaa1466475a6cbe769fb1e0e53cf2e4e1743cfb6f0617996a0fd70ac923da81c8e679b0c40592644f1afa312f979358845cf3b1d4549c175aba03682422faa6462a555f7151b81d96e5b9a5adf10eff39b3b930023ad4caae3e4a054d3bb7345a7f95a36f4b165a478f79a5a1b7bb07aaa5da9742761423af86cdba028d7d87c11b8af8839479bafb5c3b379c678396e34fb9fcc339dca2bc8e0c0e4a066ec05f265524f37cd5788a372ecc62ac59aff7388b683ea666f8ccacf12252fa0fdf365378f07fdbe8197a5c8f0c90b635777af02699bac0eddac9d009f376f21a00e1e6d976af47bf64f1f6a3da8d0e3fa1c0ab4cfe1f88b2ae5131cacdbe1eafaa09d359570b4f9a1a000ad494db88240f5ec643b5990bb26e2a3f970f06a6c0048a0a53098f59db77a7546c893c026f3203186fc70ca3f8328c02a00bfcebced1471a0c217a0979016898311c6e02a96fb0ec2178cee276cccb34fa810c0ba6bd4d1e6a0b517d8c14d7cf5d0cb4579922bbd9e066be486413d4c68be65d9f8e782ee2d2b80f8f180a0b712316ccb02d7c34774cc6a3ee8b886a020d66f2a72453c9b122c5d7f824f518080a0edd328a9b897318b6d213b9160015f32e84ed85c2c7f1b385a1b108c565c6c0ba02811638e56bf96b0d4c18aaedca3d54260f6c31fd2f8741f95af1904ae0c6d96a01d7c68de1c30ecc0e350881fd128534e02ed2ef5891c963a3701bf3c75463d2c808080a07dc5162880c44a0535ef3c3dd394a1e86fa13b34b5ae0debd4dfff603ae2c0f4a033705ce925197f8022611f67ff31fbe9205868147bd939ce334733b4cb3265028080a0e85ac7eadd78e7c1c5dfd200dc2a9f97fb68c27065720478429fa9232851cfca8080f851808080a0d40b6aa407259fa35f3dc4334beb9cd4e3d519ca74db9136739fa62372e0932b808080808080a08416086f4e463c0974b1250f044d415053edaf998d7f0cc4ea220d90f4c66990808080808080ea9e3fa06f4339708dcda8443119e6fb9292de60c25f1dbda7a6cb5ce27c712f8a8916c4abbebea0100000";

        vm.startPrank(0x2A9479FDCcf018FA417217226495EF64DA8ADDA7);

        bytes32 digest = voter.hashTypedDataV4(id, support);
        (uint8 v, bytes32 r, bytes32 s) = vm.sign(
            0x898010c9b079409192e345307acaa16d132b89feced2e4966d5c4755498557de,
            digest
        );
        assertEq(
            voter.castVoteBySig(
                id,
                0x7aE1D57b58fA6411F32948314BadD83583eE0e8C,
                address(governor),
                proof,
                support,
                v,
                r,
                s
            ),
            420000000000000000000,
            "incorrect balance"
        );
    }

    function testCannotCastVoteTwice() public {
        ovm.warp(start);
        bytes
            memory proof = hex"f9076ef90211a0e15b776b5076420f42091e0ea52061a41b0532d661e56b9c650dd43326399154a0a54dd20d0ffa65778c2ac1b10dce946da7145db552f027484164ab49de67d70da0d284d5ef148e1cc2b69ffc5c48e405ea3fd2e80acf27f0693b53314fd7254edda09c687239a4d76e4d59f0dabd7560835b70a2ab557c07855669bf86db5b88d1cea077b763df13fdb49a5e2ee5bbd211f2b855082d4bdefe1bdce41ffd76baea2073a0d8d5593dcd25fb3760ee95079f833b1ebc7a2dc5bed83ea4645adfc2f37d06d5a0c946bdf3c83852f9b9dc9ef491bb7ce81dd3a2cc4400482c6b8ed448b0094aa4a0468ba9adb68ea7dc489eed78ab94007b7cb7a286ceaa8019c96bb354b8daf5c6a089cc7ebaea39fd716c1dc825999d14e14b3d0c4b77c72397a4044c3967a469b8a0b5fbe3d3c4728239bf67660307995d5fcdf2603d42c64b07180ead886537e413a066bda2b81151c0b3810708dbc6682807e9652677c562805602d9aefdf3c88142a087b8e2220b6ac3d43a88e21d795227ec189c533a36e39004a5d08f0853ebc7aca02fbf70d1641ccabc94043d33c3f373bfb51ec522eb78d3dd81abc5d8f099c0cba0aac43707cded10062968a2cd25beb01e58e757648faec4d475dc7674f2ad034ea0106aef93b0f5a0039f5e198cddbda380900ce922333fe9181a691039a392a61aa0a81bd92e037a831b5a760b88c6111c3025bb99281254838eb9bbf714ba40994e80f90211a0b7979f910ac0340ddd7affbf3fb61fc064a5f75c42403aa087dc491264e9a98da02a9a6ecf508902655d2e6cf11744227ec5cb8a87d22cbf6134a059c0d031f8b3a04f419926ed4e13fb775e402c4b424882097ecdc96af7ad61c589acb71106f376a049131409b8941928e6fee322cb0f68ed40e2be684e059a64ef12b35eea21a227a0171d14f9816848ac1276e9b3752c944dce304616adf62c472b6386313ab024e3a02ae9c09c6273053b6c301d3a56f03ab19c4cd936b20ab3bf1e45e6eea97c5109a0e6f2c24b7840299c0858fdef707cbd73835b9c279a6401f9b0328ed2516d538ba0a6fce4426f5e6e8738862d38ff5b54ea4d8aae00775d444953dd23f867b7f986a06ff69012182563f320eee59a71ce99bc1ee04ccc9020eefb324ae85dd2941432a07c51c45a61470166ec76b4dae619d72561b0d1a8ca434564fc3a5ad2d7610c9aa0dcff68893fd23350e261652d9aea868b20d957f87cdc4a4f5979e20456c2e6e3a05930aec794b1d919962e13b1004715d8889903132f052b4357fdb264327d5bb9a0404f097a57bfe49c9685cc904f8c45dff271c7e0c43c98fc15ff5424aa7bb3c1a0739c2f3ea4839db1a0445f6d229cb59298a0eeca8e2dad0a0eca5beff69c2b4da0341a5497d43ca3d30eaa0fa119f3f5005dfe4ba7b8beb15815cdf7a3b861839ea019f7e661e03121bfc7a539e34d630ed7a90c7e9b3f9cac0f1888191f1d270b1080f90211a0240bf8715ba386c0857f5f66a7f4939f9dd03ce18e34b303cd5f00fc88bb26daa0632775b40d10c8354e6e9850ceb13805b38ef9013c103c76227fb73115bb97eaa00dfea5ae9f9de2b4f2b52bed302059e24abcd9cabfdddd57cdffa2dd3ab0fe5ba0b3674622b3f65635dc588cde4d3ae8c970af51c4e26633579ef3490cd1685f14a0428ad6652dde51b57f14839794fa3e40150a882868a2671a08650a77eb6bf381a0fe10b847711504937c88f350339de028c3554c2a89ceea6a546374ae8c2b3904a0f5817055ef9dda4ed831bfd1bdf5dadf0cf5628934cd01de22b2971b51c80bd3a0627daa0717c8c952f39dcdb0f1080233611d10ff2e65cbec32c709abccbb2661a0a91299e08e2080cea8a99316eebfc165673de9f1df78b136c66c43cfa2591974a0e34bf7636bf24cf00f6b270558f80b3b10d0268297d22cda66c767fc482e0c73a0ddbcd9c49c160c892d78051533d15df32357bf775a4a7e098f787fc3fc61d539a0d1529a51b5d1d2c95c6e832e89caa446b450145dc6c1b357ed3c06b365cd2198a03c618cd96a3c71fc0927bd462a28fa283d417740a310e69538dccb059e0229f9a0c1d3491683680579a1158563e902b5b42142f63e27542c17c34fc558afe0e13ba0f98d4e726ab20c57c5a481eb678dffeb6f94fdd3f45241a13378417a1a15db8fa01a1527c2a6bd7fec49a0085db66c9a215f4403f733f8a5e1fb8fdb2dd04d409e80f8b180808080a0119828a6928210218e9c7625eba53d0600fad1159648ed2333d0b30960c3b123a03c30738990fee2cf2b29589f0b1d53a9b68726a5067d71a1f361845184d0335f808080a036760b66a7d36a9a01969270b95326e9889ea10c106d4cdf796dba6fc1d936db808080a0f1f2bcf80ca5c91e4454b84c340e4089eb395dc995e55e4ef56b29ea1a57db8480a05b66122fed950f85b73218189230ffc9aa391682e19b19015630dc49af9f26cd80f8518080808080a0d87e0b2631f38d6e542df219ee5387e2969dfd016aeaaeb4848c39307b6d2c9a80808080a0046e88e9040d65df7376671c0a695cded7d47bd552dd9cf39c3596b41d97a2e1808080808080eb9e34675593a2afa8fe1ff3e09eaa5b961bbb9be0bca4f89c6f3e3b75c558948b8a9a6c877477891cc6cfac";

        vm.startPrank(0xba740c9035fF3c24A69e0df231149c9cd12BAe07);
        voter.castVote(
            id,
            0x7aE1D57b58fA6411F32948314BadD83583eE0e8C,
            address(governor),
            proof,
            1
        );

        vm.expectRevert("rollcall: already voted");
        voter.castVote(
            id,
            0x7aE1D57b58fA6411F32948314BadD83583eE0e8C,
            address(governor),
            proof,
            1
        );
    }

    function testCannotCastVoteWithValidProofFromEarlyBlockHeight() public {
        ovm.warp(start);
        bytes
            memory proof = hex"f9076ef90211a0f1dce22999ba5391561aa11e20c7e82b82a1d2dab1dfa167f2661ad1f1510798a0bac558f851bc499047b46b4411fa4eb3d7b041b6340cd6d5a8feb4e587645625a0dd7f82cf77647317ed5091e26875d4a0dda8394e7749378d0e469384bfa51b4da066281b02a1c6591c16778f8bf42581c2a527c96e73cbd8c19392b4662003e44fa0e42e3e317beca4f12dca9a4c88592016b6392eb50195dae824ffb8c9b4f88c24a02a4ab95a3c3a7a28147e989fc3fd6c262deb037b7827615906d60bffa953400ea000d0989e26782e827164b10bf89cc6125521132770b9af5a4123eb35cbdd3eb4a012843cc6e97e556eb2df4ca42249a60958a1fca6eb6e0ec6ffca4eaca9172ab7a0d9a7f97235f5e5965784c89ac18aa435c5e2c7c6d3433224a37ebaf420ffbe2ea0b3ad7d9d798db58616b97df20763e91c21656ecc8be9273eef6ef22a2306f762a0772e71cb1058f99f0a3422dcc9f98aae9e0b54a36e25178a7022494eaa74548aa0295797ad07f23e13b34d3152d870c45edfae6f3b6b9c7258d9744e01eab59f37a0473e62fca02434841110ea7e07072fbc2c55bb16222d0a4c53c74fb7fb7627a1a03fcc6f9b0f841c9bf0dde7c0ae51e71666305f81aa46d6b0f8200018c958d942a06ecd09aa3e2b3b87127f6cf0129ceb03cde6519c4cecbcd82cc437b7da37454da0971cd2b4fc8bbbc831a86ca05a3e24579446654db6fc57525946f6943b00e77080f90211a03e2e05d0555af0b731f4b85734500e3ab4369f194e6cfc9a19066a4f3dcc696ca0a08ac2e89d147187e6a4ef910e8c6557de756220718600e1e2355ef527d84e13a0dcc322f76845acf16373342edec74ff400a5f0565fac36cc3e9080ffb60848d0a0a90b3e47f9fe1b2dd43f12eb0bed6d4e6ff677eda080d93277ea961ec1eacf8ba0b4af7f7edb5d191530130e837c23e7abfadeed2237c357b2bdebc8e52e4c8ce9a09f91561af3edf56078230aadcf497934826f1ddc42c621c9974f1b94e17e4e38a033bfaadadaf01daaa095288b1b412fd67d58f75cfeac32d7e2cb4da51a8c4e11a0f749fad56db633f14aba0136c2d11a9daef5ddbe0eb6c29695f370d58bcc4ee9a01279bf1eaf9756149c8db63f8bbaf213f6810f5f08f31cd9671ca04bf2dd8ca7a010348e5c501993223df5653f23e6a18f71f99dec9d295260c4f4348988cc119ba0d45323c2511c3b8e2826280f2381393a5e5a28e0c59d2566023668848343f7b2a0f0805c1825d10ce928002747e5f64836e1ac6d334333922b2d0cb976903492f6a0e64b98a18404773a6fb734278541981963e0ccee03a108d318054b9e554e87d1a0d3a22e54894407b4fa19ecf70ad8b7fef34611de95e392d4d0c89cc4a05c2636a043b320e42c72d0b446342d555970c23350a4ee092ee4ee1770740a39184570aaa07ea7a9babab9920f0888ee096daab4e023bb1940497b5393f59c4818d0276dac80f90211a0b59e4a7021b5908170ae6c0a9c0ee309537dd8ced9967fcc3b7276484813def2a0632775b40d10c8354e6e9850ceb13805b38ef9013c103c76227fb73115bb97eaa00dfea5ae9f9de2b4f2b52bed302059e24abcd9cabfdddd57cdffa2dd3ab0fe5ba0b3674622b3f65635dc588cde4d3ae8c970af51c4e26633579ef3490cd1685f14a0428ad6652dde51b57f14839794fa3e40150a882868a2671a08650a77eb6bf381a0fe10b847711504937c88f350339de028c3554c2a89ceea6a546374ae8c2b3904a0f5817055ef9dda4ed831bfd1bdf5dadf0cf5628934cd01de22b2971b51c80bd3a0627daa0717c8c952f39dcdb0f1080233611d10ff2e65cbec32c709abccbb2661a0a91299e08e2080cea8a99316eebfc165673de9f1df78b136c66c43cfa2591974a0e34bf7636bf24cf00f6b270558f80b3b10d0268297d22cda66c767fc482e0c73a0ddbcd9c49c160c892d78051533d15df32357bf775a4a7e098f787fc3fc61d539a0d1529a51b5d1d2c95c6e832e89caa446b450145dc6c1b357ed3c06b365cd2198a0daa577867396f49956901ac54a2bbd876f0ca8ddd7f365abfd81d4e8f4db02dda0c1d3491683680579a1158563e902b5b42142f63e27542c17c34fc558afe0e13ba0f98d4e726ab20c57c5a481eb678dffeb6f94fdd3f45241a13378417a1a15db8fa01a1527c2a6bd7fec49a0085db66c9a215f4403f733f8a5e1fb8fdb2dd04d409e80f8b180808080a07e431eeb0007cca69d3220b9ae1da0e7be0eba190b8f15c914cc40814d5324dca03c30738990fee2cf2b29589f0b1d53a9b68726a5067d71a1f361845184d0335f808080a036760b66a7d36a9a01969270b95326e9889ea10c106d4cdf796dba6fc1d936db808080a0f1f2bcf80ca5c91e4454b84c340e4089eb395dc995e55e4ef56b29ea1a57db8480a05b66122fed950f85b73218189230ffc9aa391682e19b19015630dc49af9f26cd80f8518080808080a0d87e0b2631f38d6e542df219ee5387e2969dfd016aeaaeb4848c39307b6d2c9a80808080a0d66311d099fa925a071d77db6aac86ff8d856f69992e32cfa66f4cc25ddae321808080808080eb9e34675593a2afa8fe1ff3e09eaa5b961bbb9be0bca4f89c6f3e3b75c558948b8a9a834c203647bcd6cfac";
        vm.startPrank(0xba740c9035fF3c24A69e0df231149c9cd12BAe07);
        vm.expectRevert("root hash mismatch");
        voter.castVote(
            id,
            0x7aE1D57b58fA6411F32948314BadD83583eE0e8C,
            address(governor),
            proof,
            1
        );
    }

    function testCannotCastVoteWithZeroWeight() public {
        ovm.warp(start);
        bytes
            memory proof = hex"f906eff90211a0e15b776b5076420f42091e0ea52061a41b0532d661e56b9c650dd43326399154a0a54dd20d0ffa65778c2ac1b10dce946da7145db552f027484164ab49de67d70da0d284d5ef148e1cc2b69ffc5c48e405ea3fd2e80acf27f0693b53314fd7254edda09c687239a4d76e4d59f0dabd7560835b70a2ab557c07855669bf86db5b88d1cea077b763df13fdb49a5e2ee5bbd211f2b855082d4bdefe1bdce41ffd76baea2073a0d8d5593dcd25fb3760ee95079f833b1ebc7a2dc5bed83ea4645adfc2f37d06d5a0c946bdf3c83852f9b9dc9ef491bb7ce81dd3a2cc4400482c6b8ed448b0094aa4a0468ba9adb68ea7dc489eed78ab94007b7cb7a286ceaa8019c96bb354b8daf5c6a089cc7ebaea39fd716c1dc825999d14e14b3d0c4b77c72397a4044c3967a469b8a0b5fbe3d3c4728239bf67660307995d5fcdf2603d42c64b07180ead886537e413a066bda2b81151c0b3810708dbc6682807e9652677c562805602d9aefdf3c88142a087b8e2220b6ac3d43a88e21d795227ec189c533a36e39004a5d08f0853ebc7aca02fbf70d1641ccabc94043d33c3f373bfb51ec522eb78d3dd81abc5d8f099c0cba0aac43707cded10062968a2cd25beb01e58e757648faec4d475dc7674f2ad034ea0106aef93b0f5a0039f5e198cddbda380900ce922333fe9181a691039a392a61aa0a81bd92e037a831b5a760b88c6111c3025bb99281254838eb9bbf714ba40994e80f90211a0fdd136def4ccb4ed8ca6f1e5a07e5f3557c37f02292219367b3887d27d843615a0802c34c26604b5d68e74a8004e7e5a963ea44a5994c167ec0de11e7b0667fd21a09052966b499e0c725311bb1b42d9126c1a74875652b1459dc72b950f07bffa80a0a3895946dfc656ecabc372f67c50c40d72792039b4f1de26b23fb9e9c83b1bf3a0ea35e7561a50a8af2cb80cf982a991fb839271c825de0a62bf7af072a11fb441a065e5fd8f79729548e1d158d5df1c746536eb724b933d4436983f08495fd172d9a01c4f21a797feef48887f36776490bce88368e19a3dd1ff6da9dc11c619a42774a08d4470b306ea300ed9249058b530cd62a263887a333df7f9b9fa455a985a0cb6a01a1718cfb09e133ebf471d5c38de83ae5c09ee56973444be67166d687f1424e7a054ddaad037f6087e163465371af0a336067f8611567304ca85add6b2b6a4a3f0a0a4c5a951d06485efa06608f8cc0db2b2abc9b93ba376487ef5935bc8d183691da0e4bb066a0ba5619ed766ea8897f4d4bc4d69072961d3bd71c5935df052857c19a036565cb05624179f7dda919f66bf95f3e68a539f8fdc7c60b31cf29e782c606ca02283a4c66c0ee7b5f56776489e17999c885ee2e1d4f3d7eae974b921c2344de0a0edd918cb65c608b85d5d10ae29f381eebec3ff7228628576666886497ce2f4a1a0b1d74d1d0c265bfe554535c8c100dcb939ab4ff6dc34b6273d387eeb4f362f8d80f901f180a0b1e432a8e96a3f0a2a694ee05edd68ca36ca3141c89cace3361ebeddb56a684aa0feb537635512b37d6039936d872de4d08d0ccfc058d0d2c5094cab7e5b18d9d4a091f14a617df569e4e4b112ef7a2726e94d91bc30507db23534c4d247f06614b5a0fb3e7d374158b5eb572d83daed2c5fd43040aabeaf0808db1ebaee69ba9f6705a0a40be787957f0e14bfeb2b1a0d61400933c765d123fa422f88e2750334a5bea6a0109d30b2de07780942cb3733a4854da0ba26d0f7b45199b957705fcb6d8dbca8a0fec4e10b9e63b82528e1ef120cdb42db9b85bae30252c5ee0d2c72834cd3508aa0bddc6c0283938badb286044061618da335095fefd66acc69bcbf7fab9c2479d7a051dbdb3a7c3375317abc12425d6c154a0beb3e7e6f97c4ddedf68ebc3c6ef9dfa0672d9298edb22c87555a83579a8812c08d9a1aa0d7041b4e239b851353a1df18a0a41abd6014fd4133b6530115d4fdd6422e3a4cc4c1497592b8dbf9ad8aafba0ba0d471bc803411b4b8179ebd54e3404241049991778562fc7418a7310f7ffb12b8a0ed2c91ecbd25d300acfaca8762095f708fbd9ebc9a48129a59b9a47368704e79a00dad326ff26f61ae027f92b308810e7ac77305fdf4bd1a4f59fdace5c52fde92a0241ab8f092cbc2d7f72bac14d508e8d80a230145fe5c0c7843ce7cfc27cd9a6580f8d180a0e7b34d8daea3bdca1ceb3632b406545cfca407e0f682c976e0ea6a433e79d60f80a00da9e04822a6a21dc1f0ceb39ad6398f1f6acb2f146537ff14183f5a32557215a06a09a5b2810dfb997a998d6b4297e814cd9a446ef531fab307e713efcfc83a70808080a0a9ff66fe00b3e9809b9d7cb535dae1d6da1e97613b62db70940ca19ac9ccdeda8080a049b27da5deb84701a42dddc6089173e3907856972861093eecda5b7b0fc890518080a0b490f9b1dc24759462ba807f02d54d420bb6ac576f8f1b616f5c13f03a041e788080";
        vm.startPrank(address(0));
        vm.expectRevert("voter: balance doesnt exist");
        voter.castVote(
            id,
            0x7aE1D57b58fA6411F32948314BadD83583eE0e8C,
            address(governor),
            proof,
            1
        );
    }

    function testFinalize() public {
        ovm.warp(start);
        bytes
            memory proof = hex"f9076ef90211a0e15b776b5076420f42091e0ea52061a41b0532d661e56b9c650dd43326399154a0a54dd20d0ffa65778c2ac1b10dce946da7145db552f027484164ab49de67d70da0d284d5ef148e1cc2b69ffc5c48e405ea3fd2e80acf27f0693b53314fd7254edda09c687239a4d76e4d59f0dabd7560835b70a2ab557c07855669bf86db5b88d1cea077b763df13fdb49a5e2ee5bbd211f2b855082d4bdefe1bdce41ffd76baea2073a0d8d5593dcd25fb3760ee95079f833b1ebc7a2dc5bed83ea4645adfc2f37d06d5a0c946bdf3c83852f9b9dc9ef491bb7ce81dd3a2cc4400482c6b8ed448b0094aa4a0468ba9adb68ea7dc489eed78ab94007b7cb7a286ceaa8019c96bb354b8daf5c6a089cc7ebaea39fd716c1dc825999d14e14b3d0c4b77c72397a4044c3967a469b8a0b5fbe3d3c4728239bf67660307995d5fcdf2603d42c64b07180ead886537e413a066bda2b81151c0b3810708dbc6682807e9652677c562805602d9aefdf3c88142a087b8e2220b6ac3d43a88e21d795227ec189c533a36e39004a5d08f0853ebc7aca02fbf70d1641ccabc94043d33c3f373bfb51ec522eb78d3dd81abc5d8f099c0cba0aac43707cded10062968a2cd25beb01e58e757648faec4d475dc7674f2ad034ea0106aef93b0f5a0039f5e198cddbda380900ce922333fe9181a691039a392a61aa0a81bd92e037a831b5a760b88c6111c3025bb99281254838eb9bbf714ba40994e80f90211a0b7979f910ac0340ddd7affbf3fb61fc064a5f75c42403aa087dc491264e9a98da02a9a6ecf508902655d2e6cf11744227ec5cb8a87d22cbf6134a059c0d031f8b3a04f419926ed4e13fb775e402c4b424882097ecdc96af7ad61c589acb71106f376a049131409b8941928e6fee322cb0f68ed40e2be684e059a64ef12b35eea21a227a0171d14f9816848ac1276e9b3752c944dce304616adf62c472b6386313ab024e3a02ae9c09c6273053b6c301d3a56f03ab19c4cd936b20ab3bf1e45e6eea97c5109a0e6f2c24b7840299c0858fdef707cbd73835b9c279a6401f9b0328ed2516d538ba0a6fce4426f5e6e8738862d38ff5b54ea4d8aae00775d444953dd23f867b7f986a06ff69012182563f320eee59a71ce99bc1ee04ccc9020eefb324ae85dd2941432a07c51c45a61470166ec76b4dae619d72561b0d1a8ca434564fc3a5ad2d7610c9aa0dcff68893fd23350e261652d9aea868b20d957f87cdc4a4f5979e20456c2e6e3a05930aec794b1d919962e13b1004715d8889903132f052b4357fdb264327d5bb9a0404f097a57bfe49c9685cc904f8c45dff271c7e0c43c98fc15ff5424aa7bb3c1a0739c2f3ea4839db1a0445f6d229cb59298a0eeca8e2dad0a0eca5beff69c2b4da0341a5497d43ca3d30eaa0fa119f3f5005dfe4ba7b8beb15815cdf7a3b861839ea019f7e661e03121bfc7a539e34d630ed7a90c7e9b3f9cac0f1888191f1d270b1080f90211a0240bf8715ba386c0857f5f66a7f4939f9dd03ce18e34b303cd5f00fc88bb26daa0632775b40d10c8354e6e9850ceb13805b38ef9013c103c76227fb73115bb97eaa00dfea5ae9f9de2b4f2b52bed302059e24abcd9cabfdddd57cdffa2dd3ab0fe5ba0b3674622b3f65635dc588cde4d3ae8c970af51c4e26633579ef3490cd1685f14a0428ad6652dde51b57f14839794fa3e40150a882868a2671a08650a77eb6bf381a0fe10b847711504937c88f350339de028c3554c2a89ceea6a546374ae8c2b3904a0f5817055ef9dda4ed831bfd1bdf5dadf0cf5628934cd01de22b2971b51c80bd3a0627daa0717c8c952f39dcdb0f1080233611d10ff2e65cbec32c709abccbb2661a0a91299e08e2080cea8a99316eebfc165673de9f1df78b136c66c43cfa2591974a0e34bf7636bf24cf00f6b270558f80b3b10d0268297d22cda66c767fc482e0c73a0ddbcd9c49c160c892d78051533d15df32357bf775a4a7e098f787fc3fc61d539a0d1529a51b5d1d2c95c6e832e89caa446b450145dc6c1b357ed3c06b365cd2198a03c618cd96a3c71fc0927bd462a28fa283d417740a310e69538dccb059e0229f9a0c1d3491683680579a1158563e902b5b42142f63e27542c17c34fc558afe0e13ba0f98d4e726ab20c57c5a481eb678dffeb6f94fdd3f45241a13378417a1a15db8fa01a1527c2a6bd7fec49a0085db66c9a215f4403f733f8a5e1fb8fdb2dd04d409e80f8b180808080a0119828a6928210218e9c7625eba53d0600fad1159648ed2333d0b30960c3b123a03c30738990fee2cf2b29589f0b1d53a9b68726a5067d71a1f361845184d0335f808080a036760b66a7d36a9a01969270b95326e9889ea10c106d4cdf796dba6fc1d936db808080a0f1f2bcf80ca5c91e4454b84c340e4089eb395dc995e55e4ef56b29ea1a57db8480a05b66122fed950f85b73218189230ffc9aa391682e19b19015630dc49af9f26cd80f8518080808080a0d87e0b2631f38d6e542df219ee5387e2969dfd016aeaaeb4848c39307b6d2c9a80808080a0046e88e9040d65df7376671c0a695cded7d47bd552dd9cf39c3596b41d97a2e1808080808080eb9e34675593a2afa8fe1ff3e09eaa5b961bbb9be0bca4f89c6f3e3b75c558948b8a9a6c877477891cc6cfac";

        vm.startPrank(0xba740c9035fF3c24A69e0df231149c9cd12BAe07);
        uint256 balance = voter.castVote(
            id,
            0x7aE1D57b58fA6411F32948314BadD83583eE0e8C,
            address(governor),
            proof,
            1
        );

        ovm.warp(end);

        voter.queue(address(governor), id, 19e5);
        assertEq(governor.queueId(), id, "queue id mismatch");

        uint256[10] memory expect = [
            uint256(0),
            balance,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0
        ];
        uint256[10] memory actual = voter.votes(address(governor), id);

        for (uint256 i = 0; i < expect.length; i++) {
            assertEq(actual[i], expect[i], "votes mismatch");
            assertEq(governor.queueVotes(i), expect[i], "votes mismatch");
        }

        vm.expectRevert("voter: not ready");
        voter.queue(address(governor), id, 19e5);
    }
}
